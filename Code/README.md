Contains code (600+ sloc)
